<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - StageApp</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link href="css/themes.css" rel="stylesheet">
    <link href="css/animations.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/feather-icons@4.29.0/dist/feather.min.css" rel="stylesheet">
</head>
<body data-theme="light">
    <!-- Navbar Placeholder -->
    <div id="navbar-placeholder"></div>

    <!-- Profile Section Start -->
    <section class="section bg-soft-primary">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="card shadow rounded border-0 p-4">
                        <div class="row align-items-center">
                            <div class="col-lg-3 col-md-4">
                                <div class="profile-pic text-center">
                                    <img src="images/team/01.jpg" class="avatar avatar-large rounded-circle shadow" alt="Profile Image">
                                    <div class="mt-3">
                                        <h5 class="mb-1" id="profile-name">Loading...</h5>
                                        <p class="text-muted mb-0" id="profile-role">Loading...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-9 col-md-8 mt-4 mt-md-0">
                                <h3 class="mb-4">Profile Information</h3>
                                <form id="profile-form" class="profile-edit">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="name" class="form-label">Full Name</label>
                                                <input type="text" class="form-control" id="name" name="name" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="email" class="form-label">Email Address</label>
                                                <input type="email" class="form-control" id="email" name="email" required>
                                            </div>
                                        </div>
                                        <!-- Role-specific fields -->
                                        <div class="col-12" id="role-fields">
                                            <!-- Dynamic fields will be inserted here -->
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <button type="submit" class="btn btn-primary">Update Profile</button>
                                        <button type="button" class="btn btn-danger ms-2" id="delete-account">Delete Account</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Profile Section End -->

    <!-- Document Management Section Start -->
    <section class="section">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="card shadow rounded border-0 p-4">
                        <h4 class="mb-4">Document Management</h4>
                        <!-- Upload Form -->
                        <form id="document-upload-form" enctype="multipart/form-data" class="mb-4">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="doc-name" class="form-label">Document Name</label>
                                        <input type="text" class="form-control" id="doc-name" name="name" required>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="doc-type" class="form-label">Type</label>
                                        <select class="form-control" id="doc-type" name="type" required>
                                            <option value="CV">CV</option>
                                            <option value="Motivation Letter">Motivation Letter</option>
                                            <option value="Report">Report</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="doc-file" class="form-label">File</label>
                                        <input type="file" class="form-control" id="doc-file" name="file" accept=".pdf,.doc,.docx,.jpg,.png" required>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <label class="form-label">&nbsp;</label>
                                        <button type="submit" class="btn btn-primary w-100">Upload</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                        <!-- Documents List -->
                        <div id="documents-list" class="table-responsive">
                            <table class="table table-center">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Size</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Documents will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Document Management Section End -->

    <!-- Footer Start -->
    <footer class="bg-footer">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="py-5">
                        <div class="row align-items-center">
                            <div class="col-sm-3">
                                <div class="text-center text-sm-start">
                                    <a href="index.html"><img src="images/logo-light.png" alt=""></a>
                                </div>
                            </div>
                            <div class="col-sm-9 mt-4 mt-sm-0">
                                <ul class="list-unstyled footer-list terms-service text-center text-sm-end mb-0">
                                    <li class="list-inline-item my-2"><a href="index.html" class="text-foot fs-6 fw-medium me-2"><i class="mdi mdi-circle-small"></i> Home</a></li>
                                    <li class="list-inline-item my-2"><a href="offres-stage.html" class="text-foot fs-6 fw-medium me-2"><i class="mdi mdi-circle-small"></i> Stages</a></li>
                                    <li class="list-inline-item my-2"><a href="about.html" class="text-foot fs-6 fw-medium me-2"><i class="mdi mdi-circle-small"></i> About</a></li>
                                    <li class="list-inline-item my-2"><a href="contact.html" class="text-foot fs-6 fw-medium me-2"><i class="mdi mdi-circle-small"></i> Contact</a></li>
                                    <li class="list-inline-item my-2"><a href="faq.html" class="text-foot fs-6 fw-medium"><i class="mdi mdi-circle-small"></i> FAQ</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="py-4 footer-bar">
            <div class="container text-center">
                <div class="row align-items-center">
                    <div class="col-sm-6">
                        <div class="text-sm-start">
                            <p class="mb-0 fw-medium">Â© <script>document.write(new Date().getFullYear())</script> StageApp. Design with <i class="mdi mdi-heart text-danger"></i> by StageApp.</p>
                        </div>
                    </div>
                    <div class="col-sm-6 mt-4 mt-sm-0">
                        <ul class="list-unstyled social-icon foot-social-icon text-sm-end mb-0">
                            <li class="list-inline-item"><a href="#" target="_blank" class="rounded"><i data-feather="linkedin" class="fea icon-sm align-middle"></i></a></li>
                            <li class="list-inline-item"><a href="#" target="_blank" class="rounded"><i data-feather="facebook" class="fea icon-sm align-middle"></i></a></li>
                            <li class="list-inline-item"><a href="#" target="_blank" class="rounded"><i data-feather="twitter" class="fea icon-sm align-middle"></i></a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <!-- Footer End -->

    <!-- Back to top -->
    <a href="#" onclick="topFunction()" id="back-to-top" class="back-to-top rounded fs-5"><i data-feather="arrow-up" class="fea icon-sm align-middle"></i></a>

    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/feather.min.js"></script>
    <script src="js/main.js"></script>
    <script src="js/theme.js"></script>
    <script src="js/components.js"></script>
    <script>
        feather.replace();

        // Profile Management
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            // Load profile data
            fetch('/api/user', {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('profile-name').textContent = data.name;
                document.getElementById('profile-role').textContent = data.role;
                document.getElementById('name').value = data.name;
                document.getElementById('email').value = data.email;

                // Add role-specific fields
                const roleFields = document.getElementById('role-fields');
                if (data.role === 'Etudiant') {
                    roleFields.innerHTML = `
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="student_id" class="form-label">Student ID</label>
                                <input type="text" class="form-control" id="student_id" name="student_id" value="${data.student_id || ''}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="formation" class="form-label">Formation</label>
                                <input type="text" class="form-control" id="formation" name="formation" value="${data.formation || ''}" required>
                            </div>
                        </div>
                    `;
                } else if (data.role === 'Entreprise') {
                    roleFields.innerHTML = `
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="company_name" class="form-label">Company Name</label>
                                <input type="text" class="form-control" id="company_name" name="company_name" value="${data.company_name || ''}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="siret" class="form-label">SIRET</label>
                                <input type="text" class="form-control" id="siret" name="siret" value="${data.siret || ''}" required>
                            </div>
                        </div>
                    `;
                } else if (data.role === 'Encadrant') {
                    roleFields.innerHTML = `
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="department" class="form-label">Department</label>
                                <input type="text" class="form-control" id="department" name="department" value="${data.department || ''}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="speciality" class="form-label">Speciality</label>
                                <input type="text" class="form-control" id="speciality" name="speciality" value="${data.speciality || ''}" required>
                            </div>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading profile:', error);
                alert('Error loading profile data');
            });

            // Update profile
            document.getElementById('profile-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);

                fetch('/api/user', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error updating profile:', error);
                    alert('Error updating profile');
                });
            });

            // Delete account
            document.getElementById('delete-account').addEventListener('click', function() {
                if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                    fetch('/api/user', {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                        localStorage.removeItem('auth_token');
                        window.location.href = 'login.html';
                    })
                    .catch(error => {
                        console.error('Error deleting account:', error);
                        alert('Error deleting account');
                    });
                }
            });

            // Load documents
            loadDocuments();

            // Upload document
            document.getElementById('document-upload-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(e.target);

                fetch('/api/documents', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    alert('Document uploaded successfully');
                    loadDocuments();
                    e.target.reset();
                })
                .catch(error => {
                    console.error('Error uploading document:', error);
                    alert('Error uploading document');
                });
            });
        });

        function loadDocuments() {
            const token = localStorage.getItem('auth_token');
            fetch('/api/documents', {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(response => response.json())
            .then(documents => {
                const tbody = document.querySelector('#documents-list tbody');
                tbody.innerHTML = '';
                documents.forEach(doc => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${doc.name}</td>
                        <td>${doc.type}</td>
                        <td>${formatFileSize(doc.size)}</td>
                        <td><span class="badge bg-${getStatusColor(doc.status)}">${doc.status}</span></td>
                        <td>
                            <a href="/storage/${doc.path}" download class="btn btn-sm btn-outline-primary me-2">Download</a>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDocument(${doc.id})">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            })
            .catch(error => {
                console.error('Error loading documents:', error);
            });
        }

        function deleteDocument(id) {
            if (confirm('Are you sure you want to delete this document?')) {
                const token = localStorage.getItem('auth_token');
                fetch(`/api/documents/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                .then(() => {
                    alert('Document deleted successfully');
                    loadDocuments();
                })
                .catch(error => {
                    console.error('Error deleting document:', error);
                    alert('Error deleting document');
                });
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getStatusColor(status) {
            switch (status) {
                case 'validated': return 'success';
                case 'rejected': return 'danger';
                default: return 'warning';
            }
        }
    </script>
</body>
</html>